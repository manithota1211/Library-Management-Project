pipeline {
    agent any

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'qa', 'prod'],
            description: 'Select environment to deploy'
        )
        string(
            name: 'Version', 
            description: 'Enter the app version'
        )
        string(
            name: 'AWS_REGION',
            defaultValue: 'ap-south-1',
            description: 'Enter AWS region to deploy'
        )
        string(
            name: 'FRONTEND_REPO',
            defaultValue: '820198200488.dkr.ecr.ap-south-1.amazonaws.com/library-frontend',
            description: 'Frontend ECR repo'
        )
        string(
            name: 'BACKEND_REPO',
            defaultValue: '820198200488.dkr.ecr.ap-south-1.amazonaws.com/library-backend',
            description: 'Backend ECR repo'
        )
        string(
            name: 'K8s_NAMESPACE',
            defaultValue: 'dev',
            description: 'K8s namespace to deploy'
        )
    }

    environment {
        AWS_CRED = credentials('aws_cred')
    }

    stages {
        stage('Clone Repository') {
            steps {
                echo "Cloning repository..."
                git url: "https://github.com/manithota1211/Library-Management-Project.git", branch: 'master'
            }
        }

        stage('Build Docker Images') {
            steps {
                echo "Building frontend and backend images..."
                sh "docker build -t ${params.FRONTEND_REPO}:${params.Version} -f Dockerfile ."
                sh "docker build -t ${params.BACKEND_REPO}:${params.Version} -f Dockerfile.backend ."
            }
        }

        stage('Push Images to ECR') {
            steps {
                script {
                    withAWS(credentials: 'aws_cred', region: "${params.AWS_REGION}") {
                        sh """
                        # Login and push frontend
                        aws ecr get-login-password --region ${params.AWS_REGION} | docker login --username AWS --password-stdin ${params.FRONTEND_REPO}
                        docker push ${params.FRONTEND_REPO}:${params.Version}

                        # Login and push backend
                        aws ecr get-login-password --region ${params.AWS_REGION} | docker login --username AWS --password-stdin ${params.BACKEND_REPO}
                        docker push ${params.BACKEND_REPO}:${params.Version}
                        """
                    }
                }
            }
        }

        stage('Configure EKS Access') {
            steps {
                script {
                    withAWS(credentials: 'aws_cred', region: "${params.AWS_REGION}") {
                        sh """
                        aws eks update-kubeconfig --region ${params.AWS_REGION} --name mani-cluster --role-arn arn:aws:iam::820198200488:role/eks_access
                        kubectl get nodes
                        """
                    }
                }
            }
        }

        stage('Create Namespace') {
            steps {
                script {
                    sh """
                    kubectl get namespace ${params.K8s_NAMESPACE} || kubectl create namespace ${params.K8s_NAMESPACE}
                    """
                }
            }
        }

        stage('Deploy MongoDB') {
            steps {
                script {
                    sh "kubectl apply -f k8s/mongo.yaml -n ${params.K8s_NAMESPACE}"
                }
            }
        }

        stage('Deploy Frontend and Backend') {
            steps {
                script {
                    echo "Updating deployments with new images..."
                    # Replace placeholders in deployment files
                    sh """
                    sed -i 's|IMAGE_FRONTEND_PLACEHOLDER|${params.FRONTEND_REPO}:${params.Version}|g' k8s/frontend-deployment.yaml
                    sed -i 's|IMAGE_BACKEND_PLACEHOLDER|${params.BACKEND_REPO}:${params.Version}|g' k8s/backend-deployment.yaml
                    """

                    # Apply deployments
                    sh "kubectl apply -f k8s/frontend-deployment.yaml -n ${params.K8s_NAMESPACE}"
                    sh "kubectl apply -f k8s/backend-deployment.yaml -n ${params.K8s_NAMESPACE}"

                    # Ensure MONGODB_URI is set in frontend and backend
                    sh """
                    kubectl set env deployment/library-frontend-deployment MONGODB_URI=mongodb://mongodb-service:27017/libraryDB -n ${params.K8s_NAMESPACE}
                    kubectl set env deployment/library-backend-deployment MONGODB_URI=mongodb://mongodb-service:27017/libraryDB -n ${params.K8s_NAMESPACE}
                    """
                }
            }
        }

        stage('Deploy Ingress') {
            steps {
                script {
                    sh "kubectl apply -f k8s/ingress.yaml -n ${params.K8s_NAMESPACE}"
                }
            }
        }

        stage('Verify Deployments') {
            steps {
                script {
                    sh """
                    kubectl get deployments -n ${params.K8s_NAMESPACE}
                    kubectl get pods -n ${params.K8s_NAMESPACE}
                    kubectl get svc -n ${params.K8s_NAMESPACE}
                    kubectl get ingress -n ${params.K8s_NAMESPACE}
                    """
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment to ${params.ENVIRONMENT} environment successful!"
        }
        failure {
            echo "❌ Deployment to ${params.ENVIRONMENT} environment failed."
        }
    }
}
