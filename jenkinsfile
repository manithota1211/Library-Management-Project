pipeline {
    agent any

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'qa', 'prod'],
            description: 'Select environment to deploy'
        )
        string(
            name: 'Version', 
            description: 'Enter the app version'
        )
        string(
            name: 'IMAGE_TAG',
            defaultValue: 'latest',
            description: 'Enter the docker image tag'
        )
        string(
            name: 'AWS_REGION',
            defaultValue: 'ap-south-1',
            description: 'Enter AWS region to deploy'
        )
        string(
            name: 'FRONTEND_REPO',
            defaultValue: '820198200488.dkr.ecr.ap-south-1.amazonaws.com/pipeline',
            description:  'ECR repo for frontend'
        )
        string(
            name: 'BACKEND_REPO',
            defaultValue: '820198200488.dkr.ecr.ap-south-1.amazonaws.com/pipeline-backend',
            description: 'ECR repo for backend'
        )
        string(
            name: 'K8s_NAMESPACE',
            defaultValue: 'dev',
            description: 'Enter the k8s namespace to deploy'
        )
    }

    environment {
        AWS_CRED = credentials('aws_cred')
    }

    stages {
        stage('Clone') {
            steps {
                echo "Cloning repository"
                git url: "https://github.com/manithota1211/Library-Management-Project.git",
                    branch: 'master'
            }
        }

        stage('Build Docker Images') {
            steps {
                echo "Building frontend Docker image"
                sh "docker build -t ${params.FRONTEND_REPO}:${params.IMAGE_TAG} -f Dockerfile ."

                echo "Building backend Docker image"
                sh "docker build -t ${params.BACKEND_REPO}:${params.IMAGE_TAG} -f Dockerfile.backend ."
            }
        }

        stage('Push to ECR') {
            steps {
                script {
                    echo "Pushing frontend image to ECR"
                    withAWS(credentials: 'aws_cred', region: "${params.AWS_REGION}") {
                        sh """
                        aws ecr get-login-password --region ${params.AWS_REGION} | docker login --username AWS --password-stdin ${params.FRONTEND_REPO}
                        docker tag ${params.FRONTEND_REPO}:${params.IMAGE_TAG} ${params.FRONTEND_REPO}:${params.Version}
                        docker push ${params.FRONTEND_REPO}:${params.Version}
                        """
                    }

                    echo "Pushing backend image to ECR"
                    withAWS(credentials: 'aws_cred', region: "${params.AWS_REGION}") {
                        sh """
                        aws ecr get-login-password --region ${params.AWS_REGION} | docker login --username AWS --password-stdin ${params.BACKEND_REPO}
                        docker tag ${params.BACKEND_REPO}:${params.IMAGE_TAG} ${params.BACKEND_REPO}:${params.Version}
                        docker push ${params.BACKEND_REPO}:${params.Version}
                        """
                    }
                }
            }
        }

        stage('Update Kubernetes Manifests') {
            steps {
                script {
                    echo "Updating image tags in Kubernetes manifests"

                    // Replace placeholders in a single command
                    sh """
                    sed -i -e "s|IMAGE_FRONTEND_PLACEHOLDER|${params.FRONTEND_REPO}:${params.Version}|g" \
                           -e "s|IMAGE_BACKEND_PLACEHOLDER|${params.BACKEND_REPO}:${params.Version}|g" k8s/deployment.yaml
                    """
                }
            }
        }

        stage('Configure EKS Access') {
            steps {
                script {
                    withAWS(credentials: 'aws_cred', region: "${params.AWS_REGION}") {
                        sh """
                        aws eks update-kubeconfig --region ${params.AWS_REGION} --name mani-cluster --role-arn arn:aws:iam::820198200488:role/eks_access
                        kubectl get nodes
                        kubectl auth can-i create deployments -n ${params.K8s_NAMESPACE}
                        """
                    }
                }
            }
        }

        stage('Create Namespace') {
            steps {
                script {
                    sh """
                    kubectl get namespace ${params.K8s_NAMESPACE} || kubectl create namespace ${params.K8s_NAMESPACE}
                    """
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withAWS(credentials: 'aws_cred', region: "${params.AWS_REGION}") {
                        sh """
                        echo "Deploying MongoDB..."
                        kubectl apply -f k8s/mongo.yaml -n ${params.K8s_NAMESPACE}
                        kubectl rollout status statefulset/mongodb -n ${params.K8s_NAMESPACE}

                        echo "Deploying Application..."
                        kubectl apply -f k8s/deployment.yaml -n ${params.K8s_NAMESPACE}
                        kubectl rollout status deployment/library-frontend-deployment -n ${params.K8s_NAMESPACE}
                        kubectl rollout status deployment/library-backend-deployment -n ${params.K8s_NAMESPACE}
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Deployment to ${params.ENVIRONMENT} environment successful!"
        }
        failure {
            echo "Deployment to ${params.ENVIRONMENT} environment failed."
        }
    }
}
